<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ancient Egypt Assistant</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.06);
      --panel-2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --stroke-2: rgba(255,255,255,0.16);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --muted-2: rgba(255,255,255,0.45);
      --accent: #7c5cff;
      --accent-2: #00d4ff;
      --danger: #ff5c7a;

      --shadow: 0 10px 40px rgba(0,0,0,0.35);
      --shadow-soft: 0 6px 18px rgba(0,0,0,0.25);

      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 10px;

      --sidebar-w: 320px;
      --header-h: 56px;
      --composer-h: 96px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body { height:100%; }
    body{
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(124,92,255,0.25), transparent 55%),
                  radial-gradient(1000px 700px at 80% 30%, rgba(0,212,255,0.18), transparent 60%),
                  radial-gradient(1200px 900px at 50% 110%, rgba(255,92,122,0.12), transparent 60%),
                  var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    /* App shell */
    .app{
      height: 100vh;
      width: 100vw;
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      grid-template-rows: 1fr;
    }

    /* Sidebar */
    .sidebar{
      border-right: 1px solid var(--stroke);
      background: linear-gradient(to bottom, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      backdrop-filter: blur(16px);
      display:flex;
      flex-direction:column;
      min-width: 260px;
    }

    .sidebar-top{
      padding: 16px 16px 12px;
      border-bottom: 1px solid var(--stroke);
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 2px;
      line-height:1.1;
    }
    .brand h1{
      font-size: 14px;
      font-weight: 700;
      letter-spacing: -0.2px;
    }
    .brand p{
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 600;
      font-size: 13px;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      box-shadow: var(--shadow-soft);
    }
    .btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,0.10);
      border-color: var(--stroke-2);
    }
    .btn:active{ transform: translateY(0); }
    .btn.primary{
      border: 1px solid rgba(124,92,255,0.45);
      background: linear-gradient(135deg, rgba(124,92,255,0.30), rgba(0,212,255,0.18));
    }

    .sidebar-search{
      padding: 12px 16px;
      border-bottom: 1px solid var(--stroke);
    }
    .search{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.15);
      color: var(--text);
      outline: none;
    }
    .search::placeholder{ color: var(--muted-2); }
    .search:focus{
      border-color: rgba(124,92,255,0.55);
      box-shadow: 0 0 0 3px rgba(124,92,255,0.18);
    }

    .chat-list{
      padding: 10px 8px;
      overflow: auto;
      flex:1;
    }
    .chat-list::-webkit-scrollbar{ width: 10px; }
    .chat-list::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,0.12);
      border-radius: 10px;
    }

    .chat-item{
      display:flex;
      gap: 10px;
      align-items:center;
      padding: 10px 12px;
      margin: 6px 6px;
      border-radius: 14px;
      border: 1px solid transparent;
      background: transparent;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease;
    }
    .chat-item:hover{
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.08);
    }
    .chat-item.active{
      background: rgba(124,92,255,0.15);
      border-color: rgba(124,92,255,0.25);
    }
    .chat-dot{
      width: 10px; height:10px; border-radius:50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 0 4px rgba(124,92,255,0.10);
      flex: 0 0 auto;
    }
    .chat-meta{
      display:flex;
      flex-direction:column;
      min-width: 0;
      gap: 2px;
    }
    .chat-title{
      font-size: 13px;
      font-weight: 650;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-sub{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebar-bottom{
      border-top: 1px solid var(--stroke);
      padding: 12px 16px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      color: var(--muted);
      font-size: 12px;
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      min-width: 0;
      height: 100vh;
    }

    .header{
      height: var(--header-h);
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 0 16px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(0,0,0,0.12);
      backdrop-filter: blur(14px);
    }
    .header-left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      font-size: 12px;
      font-weight: 650;
      color: var(--text);
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .pill .spark{
      width: 8px; height:8px; border-radius:50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 0 4px rgba(0,212,255,0.08);
    }
    .header-title{
      font-size: 13px;
      font-weight: 650;
      color: var(--text);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
    }

    .header-right{
      display:flex;
      gap: 10px;
      align-items:center;
    }

    /* Chat area */
    .chat{
      flex:1;
      overflow:auto;
      padding: 24px 16px 18px;
      scroll-behavior: smooth;
    }
    .chat::-webkit-scrollbar{ width: 10px; }
    .chat::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,0.12);
      border-radius: 10px;
    }

    .thread{
      max-width: 920px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .msg{
      display:flex;
      gap: 12px;
      align-items:flex-start;
    }

    .avatar{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
      box-shadow: var(--shadow-soft);
      user-select:none;
    }
    .avatar.user{
      background: rgba(124,92,255,0.16);
      border-color: rgba(124,92,255,0.28);
    }
    .avatar.ai{
      background: rgba(0,212,255,0.12);
      border-color: rgba(0,212,255,0.22);
    }

    .bubble{
      flex: 1;
      min-width: 0;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      border-radius: var(--radius-lg);
      padding: 14px 14px 12px;
      box-shadow: var(--shadow-soft);
    }
    .bubble.user{
      background: linear-gradient(135deg, rgba(124,92,255,0.22), rgba(124,92,255,0.12));
      border-color: rgba(124,92,255,0.26);
    }

    .bubble .meta{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items:center;
      margin-bottom: 8px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
    }

    .actions{
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .icon-btn{
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.08);
      color: var(--text);
      border-radius: 10px;
      padding: 6px 8px;
      cursor:pointer;
      font-weight: 700;
      font-size: 12px;
      transition: background .15s ease, border-color .15s ease, transform .15s ease;
    }
    .icon-btn:hover{
      background: rgba(255,255,255,0.09);
      border-color: var(--stroke-2);
      transform: translateY(-1px);
    }
    .icon-btn:active{ transform: translateY(0); }
    .icon-btn.danger{
      border-color: rgba(255,92,122,0.35);
      background: rgba(255,92,122,0.10);
    }

    .content{
      font-size: 14px;
      line-height: 1.65;
      color: var(--text);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Sources */
    .sources{
      margin-top: 12px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.10);
      border-radius: 14px;
      overflow:hidden;
    }
    .sources-h{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      color: var(--muted);
      font-weight: 650;
      font-size: 12px;
      background: rgba(255,255,255,0.04);
    }
    .sources-h:hover{ background: rgba(255,255,255,0.06); }
    .sources-b{
      max-height: 360px;
      overflow:auto;
      transition: max-height .25s ease;
      padding: 8px 12px 12px;
    }
    .sources.collapsed .sources-b{
      max-height: 0;
      padding: 0 12px;
      overflow:hidden;
    }
    .src{
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }

    /* Typing / thinking */
    .typing{
      display:flex;
      gap: 8px;
      align-items:center;
      color: var(--muted);
      font-weight: 650;
      font-size: 12px;
    }
    .dots{
      display:flex;
      gap: 6px;
    }
    .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(255,255,255,0.55);
      animation: bounce 1.2s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay: .15s; }
    .dot:nth-child(3){ animation-delay: .3s; }
    @keyframes bounce{
      0%, 80%, 100%{ transform: translateY(0); opacity:.55; }
      40%{ transform: translateY(-6px); opacity:1; }
    }

    /* Composer */
    .composer{
      border-top: 1px solid var(--stroke);
      background: rgba(0,0,0,0.12);
      backdrop-filter: blur(14px);
      padding: 12px 16px;
    }
    .composer-inner{
      max-width: 920px;
      margin: 0 auto;
      display:flex;
      gap: 12px;
      align-items:flex-end;
    }
    .textarea{
      flex:1;
      min-height: 44px;
      max-height: 180px;
      resize: none;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.16);
      color: var(--text);
      outline:none;
      font-size: 14px;
      line-height: 1.4;
      box-shadow: var(--shadow-soft);
    }
    .textarea:focus{
      border-color: rgba(124,92,255,0.55);
      box-shadow: 0 0 0 3px rgba(124,92,255,0.18);
    }
    .textarea::placeholder{ color: var(--muted-2); }

    .send{
      min-width: 112px;
      height: 44px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      border-radius: 14px;
      border: 1px solid rgba(124,92,255,0.45);
      background: linear-gradient(135deg, rgba(124,92,255,0.35), rgba(0,212,255,0.18));
      color: var(--text);
      font-weight: 750;
      cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .15s ease, filter .15s ease;
    }
    .send:hover{ transform: translateY(-1px); filter: brightness(1.08); }
    .send:active{ transform: translateY(0); }
    .send:disabled{
      opacity: .65;
      cursor:not-allowed;
      transform:none;
      filter:none;
    }

    .hint{
      max-width: 920px;
      margin: 8px auto 0;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      justify-content: space-between;
      gap: 12px;
    }
    .kbd{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      border-radius: 8px;
      padding: 3px 8px;
      font-weight: 750;
      font-size: 11px;
      color: var(--text);
    }

    /* Mobile */
    @media (max-width: 920px){
      :root{ --sidebar-w: 0px; }
      .app{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
      .header-title{ max-width: 62vw; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-top">
        <div class="brand">
          <h1>Ancient Egypt Assistant</h1>
          <p>Chat-style learning interface</p>
        </div>
        <button class="btn primary" id="newChatBtn" type="button">New chat</button>
      </div>

      <div class="sidebar-search">
        <input class="search" id="searchChats" type="text" placeholder="Search chats..." />
      </div>

      <div class="chat-list" id="chatList"></div>

      <div class="sidebar-bottom">
        <span id="storageInfo">Saved locally</span>
        <button class="btn" id="clearAllBtn" type="button">Clear</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="header">
        <div class="header-left">
          <div class="pill"><span class="spark"></span><span>Assistant</span></div>
          <div class="header-title" id="chatTitle">New conversation</div>
        </div>
        <div class="header-right">
          <button class="btn" id="toggleSidebarBtn" type="button" style="display:none;">Sidebar</button>
          <button class="btn" id="regenerateBtn" type="button">Regenerate</button>
        </div>
      </header>

      <section class="chat" id="chatScroll">
        <div class="thread" id="thread"></div>
      </section>

      <footer class="composer">
        <div class="composer-inner">
          <textarea
            class="textarea"
            id="input"
            rows="1"
            placeholder="Message Ancient Egypt Assistant..."
          ></textarea>
          <button class="send" id="sendBtn" type="button">Send</button>
        </div>
        <div class="hint">
          <div>
            <span class="kbd">Enter</span> to send, <span class="kbd">Shift</span>+<span class="kbd">Enter</span> for newline
          </div>
          <div id="statusText">Ready</div>
        </div>
      </footer>
    </main>
  </div>

  <script>
    const API_URL = window.location.origin;

    // ---------- State (multi-chat) ----------
    const LS_KEY = "egypt_assistant_chats_v1";
    const state = {
      chats: [],              // [{id, title, updatedAt, messages: [{role, content, sources, ts}]}]
      activeChatId: null,
      isBusy: false,
      lastUserMessage: null,
    };

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);

    function nowTs(){
      return new Date().toISOString();
    }

    function formatTime(ts){
      try{
        const d = new Date(ts);
        return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      }catch{ return ""; }
    }

    function uid(){
      return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    }

    function clampText(text, n=60){
      const t = (text || "").trim().replace(/\s+/g, " ");
      if (t.length <= n) return t || "New conversation";
      return t.slice(0, n) + "…";
    }

    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(state.chats));
      updateStorageInfo();
    }

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      try{
        state.chats = JSON.parse(raw) || [];
      }catch{
        state.chats = [];
      }
    }

    function getActiveChat(){
      return state.chats.find(c => c.id === state.activeChatId);
    }

    function setStatus(text){
      $("statusText").textContent = text;
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, (m) => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[m]));
    }

    // Minimal markdown-ish rendering (safe):
    // - code blocks ```...```
    // - inline code `...`
    // - bold **...**
    // - bullet lines starting with "- "
    function renderRichText(text){
      let t = escapeHtml(text || "");

      // code blocks
      t = t.replace(/```([\s\S]*?)```/g, (m, p1) => {
        return `<pre style="white-space:pre-wrap;overflow:auto;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);padding:10px;border-radius:12px;margin:8px 0;"><code>${p1}</code></pre>`;
      });

      // inline code
      t = t.replace(/`([^`]+)`/g, `<code style="border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);padding:2px 6px;border-radius:8px;">$1</code>`);

      // bold
      t = t.replace(/\*\*([^*]+)\*\*/g, `<strong>$1</strong>`);

      // bullets: convert simple "- " lines into list
      const lines = t.split("\n");
      const hasBullets = lines.some(l => l.trim().startsWith("- "));
      if (hasBullets){
        let out = [];
        let inList = false;
        for (const line of lines){
          const isBullet = line.trim().startsWith("- ");
          if (isBullet && !inList){
            inList = true;
            out.push("<ul style='margin:6px 0 6px 18px;'>");
          }
          if (!isBullet && inList){
            inList = false;
            out.push("</ul>");
          }
          if (isBullet){
            out.push("<li style='margin:4px 0;'>" + line.trim().slice(2) + "</li>");
          }else{
            out.push(line === "" ? "<br/>" : line);
          }
        }
        if (inList) out.push("</ul>");
        t = out.join("\n");
      }else{
        t = t.replace(/\n/g, "<br/>");
      }
      return t;
    }

    // ---------- UI rendering ----------
    function renderChatList(filter=""){
      const list = $("chatList");
      list.innerHTML = "";

      const q = (filter || "").trim().toLowerCase();
      const chats = [...state.chats]
        .sort((a,b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""))
        .filter(c => {
          if (!q) return true;
          const hay = (c.title + " " + (c.messages?.[0]?.content || "")).toLowerCase();
          return hay.includes(q);
        });

      if (chats.length === 0){
        const empty = document.createElement("div");
        empty.style.padding = "14px 12px";
        empty.style.color = "rgba(255,255,255,0.55)";
        empty.style.fontSize = "13px";
        empty.textContent = "No chats yet.";
        list.appendChild(empty);
        return;
      }

      for (const c of chats){
        const item = document.createElement("div");
        item.className = "chat-item" + (c.id === state.activeChatId ? " active" : "");
        item.onclick = () => switchChat(c.id);

        const dot = document.createElement("div");
        dot.className = "chat-dot";

        const meta = document.createElement("div");
        meta.className = "chat-meta";

        const title = document.createElement("div");
        title.className = "chat-title";
        title.textContent = c.title || "New conversation";

        const sub = document.createElement("div");
        sub.className = "chat-sub";
        const lastMsg = (c.messages && c.messages.length) ? c.messages[c.messages.length-1].content : "No messages";
        sub.textContent = clampText(lastMsg, 44);

        meta.appendChild(title);
        meta.appendChild(sub);

        item.appendChild(dot);
        item.appendChild(meta);

        list.appendChild(item);
      }
    }

    function renderThread(){
      const thread = $("thread");
      thread.innerHTML = "";

      const chat = getActiveChat();
      $("chatTitle").textContent = chat?.title || "New conversation";

      const messages = chat?.messages || [];
      if (messages.length === 0){
        // greeting
        addToThread({
          role: "assistant",
          content: "Hello. I can help you learn about ancient Egypt. What would you like to know?",
          ts: nowTs(),
          sources: []
        }, {appendOnly:true});
      }else{
        for (const m of messages){
          addToThread(m, {appendOnly:true});
        }
      }

      scrollToBottom();
    }

    function scrollToBottom(){
      const sc = $("chatScroll");
      sc.scrollTo({ top: sc.scrollHeight, behavior: "smooth" });
    }

    function addToThread(message, {appendOnly=false}={}){
      const thread = $("thread");

      const row = document.createElement("div");
      row.className = "msg";

      const avatar = document.createElement("div");
      avatar.className = "avatar " + (message.role === "user" ? "user" : "ai");
      avatar.textContent = message.role === "user" ? "You" : "AI";

      const bubble = document.createElement("div");
      bubble.className = "bubble " + (message.role === "user" ? "user" : "");

      const meta = document.createElement("div");
      meta.className = "meta";

      const left = document.createElement("div");
      left.textContent = (message.role === "user" ? "You" : "Assistant") + " • " + formatTime(message.ts);

      const actions = document.createElement("div");
      actions.className = "actions";

      // Copy action (assistant only)
      if (message.role !== "user"){
        const copyBtn = document.createElement("button");
        copyBtn.className = "icon-btn";
        copyBtn.type = "button";
        copyBtn.textContent = "Copy";
        copyBtn.onclick = async () => {
          try{
            await navigator.clipboard.writeText(message.content || "");
            setStatus("Copied to clipboard");
            setTimeout(() => setStatus("Ready"), 1200);
          }catch{
            setStatus("Copy failed");
            setTimeout(() => setStatus("Ready"), 1200);
          }
        };
        actions.appendChild(copyBtn);
      }

      meta.appendChild(left);
      meta.appendChild(actions);

      const content = document.createElement("div");
      content.className = "content";
      content.innerHTML = renderRichText(message.content || "");

      bubble.appendChild(meta);
      bubble.appendChild(content);

      // sources (assistant messages only)
      if (message.sources && message.sources.length){
        const sWrap = document.createElement("div");
        sWrap.className = "sources collapsed";
        const sh = document.createElement("div");
        sh.className = "sources-h";
        sh.innerHTML = `<span>Sources (${message.sources.length})</span><span style="opacity:.8;">▾</span>`;
        sh.onclick = () => sWrap.classList.toggle("collapsed");

        const sb = document.createElement("div");
        sb.className = "sources-b";
        message.sources.forEach((s, idx) => {
          const item = document.createElement("div");
          item.className = "src";
          const snippet = (s.content || "").slice(0, 220);
          item.textContent = `${idx+1}. ${snippet}${(s.content||"").length > 220 ? "…" : ""}`;
          sb.appendChild(item);
        });

        sWrap.appendChild(sh);
        sWrap.appendChild(sb);
        bubble.appendChild(sWrap);
      }

      row.appendChild(avatar);
      row.appendChild(bubble);

      thread.appendChild(row);

      if (!appendOnly){
        scrollToBottom();
      }
    }

    function setBusy(busy){
      state.isBusy = busy;
      $("sendBtn").disabled = busy;
      $("input").disabled = busy;
      $("regenerateBtn").disabled = busy;
      setStatus(busy ? "Thinking…" : "Ready");
    }

    function showTyping(){
      const chat = getActiveChat();
      if (!chat) return;

      const typingMsg = {
        role: "assistant",
        content: "",
        ts: nowTs(),
        sources: [],
        _typing: true
      };

      const thread = $("thread");
      const row = document.createElement("div");
      row.className = "msg";
      row.id = "typingRow";

      const avatar = document.createElement("div");
      avatar.className = "avatar ai";
      avatar.textContent = "AI";

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const meta = document.createElement("div");
      meta.className = "meta";
      const left = document.createElement("div");
      left.textContent = "Assistant • " + formatTime(typingMsg.ts);
      meta.appendChild(left);

      const typing = document.createElement("div");
      typing.className = "typing";
      typing.innerHTML = `<span>Generating</span><span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;

      bubble.appendChild(meta);
      bubble.appendChild(typing);

      row.appendChild(avatar);
      row.appendChild(bubble);
      thread.appendChild(row);

      scrollToBottom();
    }

    function removeTyping(){
      const r = document.getElementById("typingRow");
      if (r) r.remove();
    }

    // ---------- Chat lifecycle ----------
    function newChat(){
      const id = uid();
      const chat = {
        id,
        title: "New conversation",
        updatedAt: nowTs(),
        messages: []
      };
      state.chats.unshift(chat);
      state.activeChatId = id;
      save();
      renderChatList($("searchChats").value);
      renderThread();
    }

    function switchChat(id){
      state.activeChatId = id;
      renderChatList($("searchChats").value);
      renderThread();
    }

    function updateTitleFromFirstUserMessage(chat){
      if (!chat || chat.title !== "New conversation") return;
      const firstUser = chat.messages.find(m => m.role === "user");
      if (!firstUser) return;
      chat.title = clampText(firstUser.content, 34);
    }

    function clearAll(){
      state.chats = [];
      state.activeChatId = null;
      localStorage.removeItem(LS_KEY);
      newChat();
    }

    function updateStorageInfo(){
      const size = (localStorage.getItem(LS_KEY) || "").length;
      $("storageInfo").textContent = size ? `Saved locally • ${(size/1024).toFixed(1)} KB` : "Saved locally";
    }

    // ---------- Composer behavior ----------
    function autoGrow(el){
      el.style.height = "auto";
      el.style.height = Math.min(el.scrollHeight, 180) + "px";
    }

    $("input").addEventListener("input", (e) => autoGrow(e.target));

    $("input").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });

    // ---------- Networking ----------
    async function callChatApi(message){
      const res = await fetch(`${API_URL}/chat`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          message,
          use_local_llm: false
        })
      });

      let data = null;
      try{ data = await res.json(); } catch { /* ignore */ }

      if (!res.ok){
        const msg = data?.detail || "Failed to get response";
        throw new Error(msg);
      }
      return data;
    }

    async function sendMessage(){
      const input = $("input");
      const text = (input.value || "").trim();
      if (!text || state.isBusy) return;

      const chat = getActiveChat();
      if (!chat) return;

      // push user message
      const userMsg = { role:"user", content:text, ts: nowTs(), sources: [] };
      chat.messages.push(userMsg);
      chat.updatedAt = nowTs();
      state.lastUserMessage = text;

      updateTitleFromFirstUserMessage(chat);
      save();
      renderChatList($("searchChats").value);

      // render just the new user message
      addToThread(userMsg);

      input.value = "";
      autoGrow(input);

      setBusy(true);
      showTyping();

      try{
        const data = await callChatApi(text);

        removeTyping();

        const aiMsg = {
          role: "assistant",
          content: data?.answer || "(No answer returned.)",
          sources: data?.sources || [],
          ts: nowTs()
        };

        chat.messages.push(aiMsg);
        chat.updatedAt = nowTs();
        save();

        addToThread(aiMsg);
      }catch(err){
        removeTyping();
        const errorMsg = {
          role: "assistant",
          content: `Error: ${err.message}`,
          sources: [],
          ts: nowTs()
        };
        chat.messages.push(errorMsg);
        chat.updatedAt = nowTs();
        save();
        addToThread(errorMsg);
      }finally{
        setBusy(false);
      }
    }

    async function regenerateLast(){
      if (state.isBusy) return;
      const chat = getActiveChat();
      if (!chat) return;

      // Find last user message
      const lastUser = [...chat.messages].reverse().find(m => m.role === "user");
      if (!lastUser) return;

      // Remove last assistant message if it comes after that user message
      const lastIdx = chat.messages.length - 1;
      if (chat.messages[lastIdx] && chat.messages[lastIdx].role === "assistant"){
        chat.messages.pop();
      }
      chat.updatedAt = nowTs();
      save();
      renderThread();

      setBusy(true);
      showTyping();
      try{
        const data = await callChatApi(lastUser.content);
        removeTyping();

        const aiMsg = {
          role: "assistant",
          content: data?.answer || "(No answer returned.)",
          sources: data?.sources || [],
          ts: nowTs()
        };
        chat.messages.push(aiMsg);
        chat.updatedAt = nowTs();
        save();
        addToThread(aiMsg);
      }catch(err){
        removeTyping();
        const errorMsg = {
          role: "assistant",
          content: `Error: ${err.message}`,
          sources: [],
          ts: nowTs()
        };
        chat.messages.push(errorMsg);
        chat.updatedAt = nowTs();
        save();
        addToThread(errorMsg);
      }finally{
        setBusy(false);
      }
    }

    // ---------- Wire up buttons ----------
    $("sendBtn").addEventListener("click", sendMessage);
    $("newChatBtn").addEventListener("click", newChat);
    $("clearAllBtn").addEventListener("click", clearAll);
    $("regenerateBtn").addEventListener("click", regenerateLast);

    $("searchChats").addEventListener("input", (e) => {
      renderChatList(e.target.value);
    });

    // ---------- Init ----------
    function init(){
      load();
      if (!state.chats.length){
        newChat();
      }else{
        state.activeChatId = state.chats[0].id;
        renderChatList("");
        renderThread();
      }
      updateStorageInfo();
      $("input").focus();
    }
    init();
  </script>
</body>
</html>
